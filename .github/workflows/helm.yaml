name: 'Helm - Validations'

env:
  HELM_MARIADB_CHART_PATH: "./mariadb"
  HELM_MARIADB_RELEASE: "mariadb-wp"
  HELM_WORDPRESS_CHART_PATH: "./wordpress"
  HELM_WORDPRESS_RELEASE: "wordpress"
  NAMESPACE: "wordpress-namespace"

on:
  push:
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  id-token: write
  pull-requests: write

jobs:
  lint-with-install:
    name: 'Helm: Lint with Run Installation (k3s cluster)'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create kind cluster
        uses: helm/kind-action@v1.10.0

      - name: Create namespace
        run: |
          kubectl get namespace ${{ env.NAMESPACE }} || kubectl create namespace ${{ env.NAMESPACE }}

      - name: Set up Helm
        uses: azure/setup-helm@v4.2.0

      - name: Run lint - MariaDB
        id: lint-mariadb
        run: helm lint ${{ env.HELM_MARIADB_CHART_PATH }}

      - name: Run Installation - MariaDB
        id: install-mariadb
        run: |
          helm install ${{ env.HELM_MARIADB_RELEASE }} -n ${{ env.NAMESPACE }} ${{ env.HELM_MARIADB_CHART_PATH }}

      - name: Run lint - WordPress
        id: lint-wordpress
        run: helm lint ${{ env.HELM_WORDPRESS_CHART_PATH }}


      - name: Run Installation - WordPress
        id: install-wordpress
        run: |
          helm install ${{ env.HELM_WORDPRESS_RELEASE }} -n ${{ env.NAMESPACE }} ${{ env.HELM_WORDPRESS_CHART_PATH }}